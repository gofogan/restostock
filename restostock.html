<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2c3e50">
    <meta name="description" content="Gestion de stock pour restaurant">
    <title>RestoStock 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <style>
        /* [TOUT VOTRE CSS ICI - sans modification] */
        /* Copiez tout le CSS précédent ici */
        
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.5;
            touch-action: manipulation;
        }
        
        /* ... reste du CSS ... */
    </style>
</head>
<body>
    <!-- [TOUT VOTRE HTML ICI - sans modification] -->
    <!-- Écran de connexion -->
    <div id="loginScreen" class="login-screen">
        <!-- ... contenu login ... -->
    </div>
    
    <!-- Application principale -->
    <div id="appContent" style="display: none;">
        <!-- ... contenu application ... -->
    </div>
    
    <!-- Modal -->
    <div class="modal" id="productModal">
        <!-- ... contenu modal ... -->
    </div>

    <script>
        // === CONFIGURATION FIREBASE (UNE SEULE FOIS !) ===
        // REMPLACEZ CES VALEURS PAR LES VÔTRES APRÈS AVOIR CRÉÉ VOTRE PROJET FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBTc3ECVhZcFr1gOF7FHoSS1eMeWTUY17k",
            authDomain: "restostock-cfa.firebaseapp.com",
            databaseURL: "https://restostock-cfa-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "restostock-cfa",
            storageBucket: "restostock-cfa.firebasestorage.app",
            messagingSenderId: "158313169828",
            appId: "1:158313169828:web:7aace5e1acfccf7c1b7731"
        };
        // =================================================

        // Initialiser Firebase (UNE SEULE FOIS !)
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Variables globales
        let currentRestaurant = null;
        let stockData = {
            products: [],
            movements: [],
            settings: {
                restaurantName: "",
                accessCode: "",
                lastSync: null
            }
        };
        
        let currentFilter = 'all';
        let currentSearch = '';
        let isSyncing = false;

        // Fonctions utilitaires
        function getToday() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatCFA(amount) {
            return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " CFA";
        }

        function showMessage(text, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = text;
            notification.style.background = type === 'success' ? 'var(--success)' : 
                                           type === 'warning' ? 'var(--warning)' : 'var(--danger)';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function updateSyncStatus(status, message) {
            const syncElement = document.getElementById('syncStatus');
            syncElement.className = 'sync-status ' + status;
            syncElement.innerHTML = `<i class="fas fa-${status === 'syncing' ? 'sync fa-spin' : 
                                                    status === 'synced' ? 'check-circle' : 
                                                    'exclamation-triangle'}"></i> <span>${message}</span>`;
        }

        // Initialisation
        function init() {
            console.log('Initialisation de l\'application Firebase...');
            
            // Vérifier si déjà connecté
            const savedRestaurant = localStorage.getItem('currentRestaurant');
            if (savedRestaurant) {
                try {
                    currentRestaurant = JSON.parse(savedRestaurant);
                    loadRestaurantData();
                } catch (e) {
                    console.error('Erreur chargement restaurant:', e);
                    showLoginScreen();
                }
            } else {
                showLoginScreen();
            }
            
            // Dates par défaut
            const today = getToday();
            if (document.getElementById('movementDate')) {
                document.getElementById('movementDate').value = today;
                document.getElementById('startDate').value = today;
                document.getElementById('endDate').value = today;
            }
            
            // Événements
            setupEvents();
        }

        // Afficher l'écran de connexion
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContent').style.display = 'none';
        }

        // Afficher l'application principale
        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';
            if (currentRestaurant && document.getElementById('restaurantTitle')) {
                document.getElementById('restaurantTitle').textContent = currentRestaurant.name;
            }
            
            // Charger les données
            loadProducts();
            updateDashboard();
            loadRecentMovements();
        }

        // Connexion/Inscription
        document.getElementById('loginButton').addEventListener('click', async function() {
            const restaurantName = document.getElementById('restaurantName').value.trim();
            const accessCode = document.getElementById('accessCode').value.trim();
            const loginMessage = document.getElementById('loginMessage');
            
            if (!restaurantName || !accessCode) {
                loginMessage.textContent = 'Veuillez remplir tous les champs';
                loginMessage.style.display = 'block';
                return;
            }
            
            if (accessCode.length < 4 || !/^\d+$/.test(accessCode)) {
                loginMessage.textContent = 'Le code doit contenir au moins 4 chiffres';
                loginMessage.style.display = 'block';
                return;
            }
            
            // Créer un ID unique pour le restaurant
            const restaurantId = btoa(restaurantName + ':' + accessCode).replace(/[+/=]/g, '');
            
            try {
                loginMessage.innerHTML = '<div class="loader" style="margin: 0 auto;"></div> Connexion en cours...';
                loginMessage.style.display = 'block';
                
                // Vérifier si le restaurant existe
                const restaurantRef = database.ref('restaurants/' + restaurantId);
                const snapshot = await restaurantRef.once('value');
                
                if (snapshot.exists()) {
                    // Restaurant existant - charger les données
                    currentRestaurant = {
                        id: restaurantId,
                        name: restaurantName,
                        accessCode: accessCode
                    };
                    
                    await loadRestaurantData();
                    showMessage('Connexion réussie! Données chargées.', 'success');
                } else {
                    // Nouveau restaurant - créer avec données par défaut
                    currentRestaurant = {
                        id: restaurantId,
                        name: restaurantName,
                        accessCode: accessCode
                    };
                    
                    // Données par défaut
                    stockData = {
                        products: [
                            { id: 1, name: "Tomates", unit: "kg", min: 10, stock: 15, price: 350, category: "légumes" },
                            { id: 2, name: "Riz", unit: "kg", min: 20, stock: 5, price: 500, category: "épices" },
                            { id: 3, name: "Huile d'olive", unit: "L", min: 5, stock: 8, price: 1200, category: "épices" },
                            { id: 4, name: "Poulet", unit: "kg", min: 15, stock: 20, price: 1800, category: "viandes" }
                        ],
                        movements: [],
                        settings: {
                            restaurantName: restaurantName,
                            accessCode: accessCode,
                            lastSync: new Date().toISOString(),
                            created: new Date().toISOString()
                        }
                    };
                    
                    // Sauvegarder dans Firebase
                    await saveDataToFirebase();
                    showMessage('Nouveau restaurant créé!', 'success');
                }
                
                // Sauvegarder localement
                localStorage.setItem('currentRestaurant', JSON.stringify(currentRestaurant));
                
                // Afficher l'application
                showApp();
                
            } catch (error) {
                console.error('Erreur connexion:', error);
                loginMessage.textContent = 'Erreur de connexion. Vérifiez votre connexion internet.';
                loginMessage.style.display = 'block';
            }
        });

        // Charger les données du restaurant
        async function loadRestaurantData() {
            updateSyncStatus('syncing', 'Chargement...');
            
            try {
                const restaurantRef = database.ref('restaurants/' + currentRestaurant.id);
                const snapshot = await restaurantRef.once('value');
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    stockData = data;
                    
                    // S'assurer que les arrays existent
                    if (!stockData.products) stockData.products = [];
                    if (!stockData.movements) stockData.movements = [];
                    if (!stockData.settings) stockData.settings = {};
                    
                    // Mettre à jour l'interface
                    loadProducts();
                    updateDashboard();
                    loadRecentMovements();
                    
                    // Configurer l'écoute des mises à jour en temps réel
                    setupRealtimeUpdates();
                    
                    updateSyncStatus('synced', 'Synchronisé');
                    showMessage('Données chargées avec succès', 'success');
                }
            } catch (error) {
                console.error('Erreur chargement données:', error);
                updateSyncStatus('offline', 'Hors ligne');
                showMessage('Mode hors ligne activé', 'warning');
            }
        }

        // Configurer les mises à jour en temps réel
        function setupRealtimeUpdates() {
            const restaurantRef = database.ref('restaurants/' + currentRestaurant.id);
            
            restaurantRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const newData = snapshot.val();
                    stockData = newData;
                    
                    // Mettre à jour l'interface
                    loadProducts();
                    updateDashboard();
                    loadRecentMovements();
                    
                    updateSyncStatus('synced', 'Synchronisé');
                }
            });
        }

        // Sauvegarder dans Firebase
        async function saveDataToFirebase() {
            if (!currentRestaurant) return;
            
            isSyncing = true;
            updateSyncStatus('syncing', 'Synchronisation...');
            
            try {
                // Mettre à jour la date de sync
                stockData.settings.lastSync = new Date().toISOString();
                
                const restaurantRef = database.ref('restaurants/' + currentRestaurant.id);
                await restaurantRef.set(stockData);
                
                updateSyncStatus('synced', 'Synchronisé');
                isSyncing = false;
                return true;
            } catch (error) {
                console.error('Erreur sauvegarde Firebase:', error);
                updateSyncStatus('offline', 'Erreur sync');
                isSyncing = false;
                return false;
            }
        }

        // Déterminer le statut d'un produit
        function getProductStatus(product) {
            if (product.stock > product.min) {
                return { class: 'good', text: 'OK', icon: 'fa-check-circle' };
            } else if (product.stock === product.min) {
                return { class: 'warning', text: 'Minimum', icon: 'fa-exclamation-circle' };
            } else {
                return { class: 'danger', text: 'Bas', icon: 'fa-exclamation-triangle' };
            }
        }

        // Charger les produits dans les selects
        function loadProducts() {
            const selects = ['movementProduct', 'productSelect'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                select.innerHTML = '<option value="">Choisir un produit</option>';
                stockData.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} (${product.stock} ${product.unit})`;
                    select.appendChild(option);
                });
            });
            
            updateProductsTable();
        }

        // Mettre à jour le tableau des produits avec filtres
        function updateProductsTable() {
            const tbody = document.getElementById('productsTable');
            const countElement = document.getElementById('productCount');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Filtrer les produits
            let filteredProducts = stockData.products.filter(product => {
                // Filtre par statut
                const status = getProductStatus(product);
                let statusMatch = true;
                
                if (currentFilter === 'good') {
                    statusMatch = status.class === 'good';
                } else if (currentFilter === 'warning') {
                    statusMatch = status.class === 'warning';
                } else if (currentFilter === 'danger') {
                    statusMatch = status.class === 'danger';
                }
                
                // Filtre par recherche
                const searchMatch = !currentSearch || 
                    product.name.toLowerCase().includes(currentSearch.toLowerCase()) ||
                    (product.category && product.category.toLowerCase().includes(currentSearch.toLowerCase()));
                
                return statusMatch && searchMatch;
            });
            
            // Trier par statut (bas en premier, puis minimum, puis OK)
            filteredProducts.sort((a, b) => {
                const statusA = getProductStatus(a).class;
                const statusB = getProductStatus(b).class;
                
                const order = { 'danger': 0, 'warning': 1, 'good': 2 };
                return order[statusA] - order[statusB];
            });
            
            // Afficher les produits filtrés
            filteredProducts.forEach(product => {
                const value = product.stock * product.price;
                const status = getProductStatus(product);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${product.name}</strong><br>
                        <small>Min: ${product.min} ${product.unit} | Prix: ${formatCFA(product.price)}</small>
                        ${product.category ? `<br><small style="color: #777;">${product.category}</small>` : ''}
                    </td>
                    <td>${product.stock} ${product.unit}</td>
                    <td>
                        <span class="status ${status.class}">
                            <i class="fas ${status.icon}"></i> ${status.text}
                        </span>
                    </td>
                    <td>${formatCFA(value)}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Mettre à jour le compteur
            if (countElement) {
                countElement.textContent = `${filteredProducts.length} produit${filteredProducts.length !== 1 ? 's' : ''} affiché${filteredProducts.length !== 1 ? 's' : ''}`;
            }
        }

        // Mettre à jour le tableau de bord
        function updateDashboard() {
            // Totaux
            if (document.getElementById('totalProducts')) {
                document.getElementById('totalProducts').textContent = stockData.products.length;
                
                const totalValue = stockData.products.reduce((sum, p) => sum + (p.stock * p.price), 0);
                document.getElementById('totalValue').textContent = formatCFA(totalValue);
                
                const lowStock = stockData.products.filter(p => p.stock < p.min).length;
                document.getElementById('lowStock').textContent = lowStock;
                
                const todayMovements = stockData.movements.filter(m => m.date === getToday()).length;
                document.getElementById('todayMovements').textContent = todayMovements;
                
                // Alertes
                const alertDiv = document.getElementById('stockAlert');
                const alertCount = document.getElementById('alertCount');
                const alertsList = document.getElementById('alertsList');
                
                if (lowStock > 0) {
                    if (alertDiv) alertDiv.style.display = 'flex';
                    if (alertCount) alertCount.textContent = `${lowStock} produit${lowStock > 1 ? 's' : ''}`;
                    
                    if (alertsList) {
                        let alertsHTML = '';
                        stockData.products
                            .filter(p => p.stock < p.min)
                            .forEach(p => {
                                const needed = p.min - p.stock;
                                alertsHTML += `
                                    <div class="product-item">
                                        <div>
                                            <strong>${p.name}</strong><br>
                                            <small>Stock: ${p.stock} ${p.unit} | Manque: ${needed} ${p.unit}</small>
                                        </div>
                                        <div style="color: var(--danger);">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </div>
                                    </div>
                                `;
                            });
                        alertsList.innerHTML = alertsHTML;
                    }
                } else {
                    if (alertDiv) alertDiv.style.display = 'none';
                    if (alertsList) alertsList.innerHTML = '<p style="text-align: center; padding: 20px; color: #777;">Aucune alerte</p>';
                }
            }
        }

        // Charger les mouvements récents
        function loadRecentMovements() {
            const recentDiv = document.getElementById('recentMovements');
            if (!recentDiv) return;
            
            const recentMovements = [...stockData.movements]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            if (recentMovements.length === 0) {
                recentDiv.innerHTML = '<p style="text-align: center; padding: 20px; color: #777;">Aucun mouvement récent</p>';
                return;
            }
            
            let html = '';
            recentMovements.forEach(movement => {
                const product = stockData.products.find(p => p.id === movement.productId);
                const productName = product ? product.name : 'Produit inconnu';
                const typeIcon = movement.type === 'entry' ? 'fa-arrow-down' : 
                                movement.type === 'exit' ? 'fa-arrow-up' : 'fa-adjust';
                const typeColor = movement.type === 'entry' ? 'var(--success)' : 
                                 movement.type === 'exit' ? 'var(--danger)' : 'var(--warning)';
                
                html += `
                    <div class="product-item">
                        <div>
                            <strong>${productName}</strong><br>
                            <small>${movement.date} | ${movement.quantity} ${product ? product.unit : ''}</small>
                            ${movement.reason ? `<br><small>${movement.reason}</small>` : ''}
                        </div>
                        <div style="color: ${typeColor}; font-weight: bold;">
                            <i class="fas ${typeIcon}"></i> ${formatCFA(movement.quantity * movement.price)}
                        </div>
                    </div>
                `;
            });
            
            recentDiv.innerHTML = html;
        }

        // Configurer les événements
        function setupEvents() {
            // Onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                    
                    // Mettre à jour les paramètres si besoin
                    if (tab.dataset.tab === 'settings' && currentRestaurant) {
                        if (document.getElementById('currentAccessCode')) {
                            document.getElementById('currentAccessCode').value = currentRestaurant.accessCode;
                        }
                        if (document.getElementById('currentRestaurantName')) {
                            document.getElementById('currentRestaurantName').value = currentRestaurant.name;
                        }
                    }
                });
            });
            
            // Formulaire mouvement
            const movementForm = document.getElementById('movementForm');
            if (movementForm) {
                movementForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const productId = parseInt(this.movementProduct.value);
                    const type = this.movementType.value;
                    const quantity = parseInt(this.movementQuantity.value);
                    const price = parseInt(this.movementPrice.value);
                    const date = this.movementDate.value;
                    const reason = this.movementReason ? this.movementReason.value.trim() : '';
                    
                    if (!productId || !quantity || !price) {
                        showMessage('Veuillez remplir tous les champs', 'danger');
                        return;
                    }
                    
                    const product = stockData.products.find(p => p.id === productId);
                    if (!product) {
                        showMessage('Produit non trouvé', 'danger');
                        return;
                    }
                    
                    // Mettre à jour le stock
                    if (type === 'entry') {
                        product.stock += quantity;
                    } else if (type === 'exit') {
                        if (product.stock < quantity) {
                            showMessage(`Stock insuffisant! Stock actuel: ${product.stock} ${product.unit}`, 'danger');
                            return;
                        }
                        product.stock -= quantity;
                    } else if (type === 'adjustment') {
                        // Ajustement direct
                        product.stock = quantity;
                    }
                    
                    // Mettre à jour le prix si différent
                    if (price > 0 && price !== product.price) {
                        product.price = price;
                    }
                    
                    // Enregistrer le mouvement
                    const newMovement = {
                        id: stockData.movements.length > 0 ? Math.max(...stockData.movements.map(m => m.id)) + 1 : 1,
                        date: date,
                        productId: productId,
                        type: type,
                        quantity: quantity,
                        price: price,
                        productName: product.name,
                        reason: reason || null,
                        timestamp: new Date().toISOString()
                    };
                    
                    stockData.movements.push(newMovement);
                    
                    // Sauvegarder dans Firebase
                    const saved = await saveDataToFirebase();
                    
                    if (saved) {
                        // Mettre à jour l'interface
                        loadProducts();
                        updateDashboard();
                        loadRecentMovements();
                        
                        // Réinitialiser le formulaire
                        this.reset();
                        this.movementDate.value = getToday();
                        
                        showMessage('Mouvement enregistré et synchronisé!');
                    } else {
                        showMessage('Mouvement enregistré localement (hors ligne)', 'warning');
                    }
                });
            }
            
            // Réinitialiser formulaire mouvement
            const resetMovementBtn = document.getElementById('resetMovement');
            if (resetMovementBtn) {
                resetMovementBtn.addEventListener('click', function() {
                    const movementForm = document.getElementById('movementForm');
                    if (movementForm) {
                        movementForm.reset();
                        document.getElementById('movementDate').value = getToday();
                    }
                });
            }
            
            // Modal produit
            const addProductBtn = document.getElementById('addProduct');
            if (addProductBtn) {
                addProductBtn.addEventListener('click', () => {
                    document.getElementById('productModal').style.display = 'flex';
                });
            }
            
            document.querySelectorAll('.close').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('productModal').style.display = 'none';
                });
            });
            
            // Fermer modal en cliquant à l'extérieur
            const productModal = document.getElementById('productModal');
            if (productModal) {
                productModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            }
            
            // Formulaire produit
            const productForm = document.getElementById('productForm');
            if (productForm) {
                productForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const name = this.productName.value.trim();
                    const unit = this.productUnit.value;
                    const min = parseInt(this.minStock.value);
                    const stock = parseInt(this.initialStock.value) || 0;
                    const price = parseInt(this.productPrice.value) || 0;
                    const category = this.productCategory ? this.productCategory.value || null : null;
                    
                    if (!name || !unit || isNaN(min)) {
                        showMessage('Veuillez remplir les champs obligatoires', 'danger');
                        return;
                    }
                    
                    // Vérifier si existe déjà
                    if (stockData.products.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                        showMessage('Ce produit existe déjà', 'danger');
                        return;
                    }
                    
                    // Ajouter le produit
                    const newProduct = {
                        id: stockData.products.length > 0 ? Math.max(...stockData.products.map(p => p.id)) + 1 : 1,
                        name: name,
                        unit: unit,
                        min: min,
                        stock: stock,
                        price: price,
                        category: category
                    };
                    
                    stockData.products.push(newProduct);
                    
                    // Sauvegarder dans Firebase
                    const saved = await saveDataToFirebase();
                    
                    if (saved) {
                        // Mettre à jour l'interface
                        loadProducts();
                        updateDashboard();
                        
                        // Fermer modal et réinitialiser
                        document.getElementById('productModal').style.display = 'none';
                        this.reset();
                        
                        showMessage('Produit ajouté et synchronisé!');
                    } else {
                        showMessage('Produit ajouté localement (hors ligne)', 'warning');
                    }
                });
            }
            
            // Valorisation produit
            const productSelect = document.getElementById('productSelect');
            if (productSelect) {
                productSelect.addEventListener('change', function() {
                    const productId = parseInt(this.value);
                    const resultDiv = document.getElementById('valuationResult');
                    
                    if (!productId) {
                        if (resultDiv) resultDiv.style.display = 'none';
                        return;
                    }
                    
                    const product = stockData.products.find(p => p.id === productId);
                    if (product && resultDiv) {
                        document.getElementById('valStock').textContent = `${product.stock} ${product.unit}`;
                        document.getElementById('valTotal').textContent = formatCFA(product.stock * product.price);
                        resultDiv.style.display = 'block';
                    }
                });
            }
            
            // Filtres de produits
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentFilter = this.dataset.filter;
                    updateProductsTable();
                });
            });
            
            // Recherche de produits
            const productSearch = document.getElementById('productSearch');
            if (productSearch) {
                productSearch.addEventListener('input', function() {
                    currentSearch = this.value;
                    updateProductsTable();
                });
            }
            
            // Statistiques
            const generateStatsBtn = document.getElementById('generateStats');
            if (generateStatsBtn) {
                generateStatsBtn.addEventListener('click', function() {
                    const start = document.getElementById('startDate').value;
                    const end = document.getElementById('endDate').value;
                    
                    if (!start || !end) {
                        showMessage('Veuillez sélectionner une période', 'danger');
                        return;
                    }
                    
                    if (start > end) {
                        showMessage('La date de début doit être avant la date de fin', 'danger');
                        return;
                    }
                    
                    // Filtrer les mouvements de la période
                    const periodMovements = stockData.movements.filter(m => {
                        return m.date >= start && m.date <= end;
                    });
                    
                    if (periodMovements.length === 0) {
                        const statsContent = document.getElementById('statsContent');
                        if (statsContent) {
                            statsContent.innerHTML = `
                                <p style="text-align: center; padding: 20px; color: #777;">
                                    Aucun mouvement trouvé pour cette période
                                </p>
                            `;
                        }
                        const statsResults = document.getElementById('statsResults');
                        if (statsResults) {
                            statsResults.style.display = 'block';
                        }
                        return;
                    }
                    
                    // Analyser les données
                    const purchasesByProduct = {};
                    const consumptionByProduct = {};
                    
                    periodMovements.forEach(movement => {
                        if (movement.type === 'entry') {
                            if (!purchasesByProduct[movement.productId]) {
                                purchasesByProduct[movement.productId] = {
                                    count: 0,
                                    totalQuantity: 0,
                                    totalValue: 0,
                                    name: movement.productName
                                };
                            }
                            purchasesByProduct[movement.productId].count++;
                            purchasesByProduct[movement.productId].totalQuantity += movement.quantity;
                            purchasesByProduct[movement.productId].totalValue += movement.quantity * movement.price;
                        } else if (movement.type === 'exit') {
                            if (!consumptionByProduct[movement.productId]) {
                                consumptionByProduct[movement.productId] = {
                                    totalQuantity: 0,
                                    totalValue: 0,
                                    name: movement.productName
                                };
                            }
                            consumptionByProduct[movement.productId].totalQuantity += movement.quantity;
                            consumptionByProduct[movement.productId].totalValue += movement.quantity * movement.price;
                        }
                    });
                    
                    // Convertir en tableaux et trier
                    const topPurchases = Object.values(purchasesByProduct)
                        .sort((a, b) => b.count - a.count || b.totalValue - a.totalValue);
                    
                    const topConsumptions = Object.values(consumptionByProduct)
                        .sort((a, b) => b.totalQuantity - a.totalQuantity || b.totalValue - a.totalValue);
                    
                    // Afficher les résultats
                    let statsHTML = '';
                    
                    // Résumé
                    const totalPurchases = periodMovements.filter(m => m.type === 'entry').length;
                    const totalConsumptions = periodMovements.filter(m => m.type === 'exit').length;
                    const totalPurchasesValue = periodMovements
                        .filter(m => m.type === 'entry')
                        .reduce((sum, m) => sum + (m.quantity * m.price), 0);
                    const totalConsumptionsValue = periodMovements
                        .filter(m => m.type === 'exit')
                        .reduce((sum, m) => sum + (m.quantity * m.price), 0);
                    
                    statsHTML += `
                        <div class="summary-card">
                            <h4 style="margin-bottom: 10px; color: var(--primary); display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-clipboard-list"></i> Résumé de la période
                            </h4>
                            <div class="summary-item">
                                <span>Période analysée</span>
                                <strong>${start} au ${end}</strong>
                            </div>
                            <div class="summary-item">
                                <span>Nombre total de mouvements</span>
                                <strong>${periodMovements.length}</strong>
                            </div>
                            <div class="summary-item">
                                <span>Nombre d'achats (entrées)</span>
                                <strong style="color: var(--secondary);">${totalPurchaces}</strong>
                            </div>
                            <div class="summary-item">
                                <span>Valeur totale des achats</span>
                                <strong style="color: var(--secondary);">${formatCFA(totalPurchasesValue)}</strong>
                            </div>
                            <div class="summary-item">
                                <span>Nombre de consommations (sorties)</span>
                                <strong style="color: var(--danger);">${totalConsumptions}</strong>
                            </div>
                            <div class="summary-item">
                                <span>Valeur totale consommée</span>
                                <strong style="color: var(--danger);">${formatCFA(totalConsumptionsValue)}</strong>
                            </div>
                        </div>
                    `;
                    
                    // Achats détaillés
                    if (topPurchases.length > 0) {
                        statsHTML += `
                            <div class="card" style="margin-top: 15px;">
                                <h4 style="margin-bottom: 10px; color: var(--primary); display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-shopping-cart"></i> Détail des achats par produit
                                </h4>
                        `;
                        
                        topPurchases.forEach((item, index) => {
                            statsHTML += `
                                <div class="product-item" style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                                    <div>
                                        <strong>${item.name}</strong><br>
                                        <small>
                                            Acheté <strong style="color: var(--secondary);">${item.count} fois</strong><br>
                                            Quantité totale: ${item.totalQuantity} | Valeur totale: ${formatCFA(item.totalValue)}
                                        </small>
                                    </div>
                                    <div style="text-align: center; min-width: 60px;">
                                        <div style="color: var(--secondary); font-weight: bold; font-size: 1.2rem;">
                                            ${item.count}
                                        </div>
                                        <small style="color: #777; font-size: 0.8rem;">fois</small>
                                    </div>
                                </div>
                            `;
                        });
                        
                        statsHTML += `</div>`;
                    }
                    
                    // Consommations
                    if (topConsumptions.length > 0) {
                        statsHTML += `
                            <div class="card" style="margin-top: 15px;">
                                <h4 style="margin-bottom: 10px; color: var(--primary); display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-utensils"></i> Détail des consommations par produit
                                </h4>
                        `;
                        
                        topConsumptions.forEach((item, index) => {
                            statsHTML += `
                                <div class="product-item" style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                                    <div>
                                        <strong>${item.name}</strong><br>
                                        <small>
                                            Consommé: ${item.totalQuantity}<br>
                                            Valeur totale: ${formatCFA(item.totalValue)}
                                        </small>
                                    </div>
                                    <div style="text-align: center; min-width: 60px;">
                                        <div style="color: var(--danger); font-weight: bold; font-size: 1.2rem;">
                                            ${item.totalQuantity}
                                        </div>
                                        <small style="color: #777; font-size: 0.8rem;">quantité</small>
                                    </div>
                                </div>
                            `;
                        });
                        
                        statsHTML += `</div>`;
                    }
                    
                    const statsContent = document.getElementById('statsContent');
                    if (statsContent) {
                        statsContent.innerHTML = statsHTML;
                    }
                    const statsResults = document.getElementById('statsResults');
                    if (statsResults) {
                        statsResults.style.display = 'block';
                    }
                });
            }
            
            // Déconnexion
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    localStorage.removeItem('currentRestaurant');
                    currentRestaurant = null;
                    showLoginScreen();
                });
            }
            
            // Forcer la synchronisation
            const forceSyncBtn = document.getElementById('forceSync');
            if (forceSyncBtn) {
                forceSyncBtn.addEventListener('click', async function() {
                    const saved = await saveDataToFirebase();
                    if (saved) {
                        showMessage('Synchronisation forcée réussie!');
                    } else {
                        showMessage('Erreur de synchronisation', 'danger');
                    }
                });
            }
            
            // Exporter les données
            const exportDataBtn = document.getElementById('exportData');
            if (exportDataBtn) {
                exportDataBtn.addEventListener('click', function() {
                    const dataStr = JSON.stringify(stockData, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    
                    const exportFileDefaultName = `restostock_${currentRestaurant.name}_${getToday()}.json`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                    
                    showMessage('Données exportées avec succès!');
                });
            }
            
            // Changer le code
            const changeCodeBtn = document.getElementById('changeCode');
            if (changeCodeBtn) {
                changeCodeBtn.addEventListener('click', async function() {
                    const newCodeInput = document.getElementById('newAccessCode');
                    if (!newCodeInput) return;
                    
                    const newCode = newCodeInput.value.trim();
                    
                    if (!newCode || newCode.length < 4 || !/^\d+$/.test(newCode)) {
                        showMessage('Le code doit contenir au moins 4 chiffres', 'danger');
                        return;
                    }
                    
                    if (newCode === currentRestaurant.accessCode) {
                        showMessage('Le nouveau code est identique à l\'ancien', 'warning');
                        return;
                    }
                    
                    // Mettre à jour le code
                    currentRestaurant.accessCode = newCode;
                    stockData.settings.accessCode = newCode;
                    
                    // Régénérer l'ID du restaurant
                    const newRestaurantId = btoa(currentRestaurant.name + ':' + newCode).replace(/[+/=]/g, '');
                    
                    try {
                        // Sauvegarder dans le nouveau chemin
                        const newRef = database.ref('restaurants/' + newRestaurantId);
                        await newRef.set(stockData);
                        
                        // Supprimer l'ancien
                        const oldRef = database.ref('restaurants/' + currentRestaurant.id);
                        await oldRef.remove();
                        
                        // Mettre à jour l'ID
                        currentRestaurant.id = newRestaurantId;
                        
                        // Sauvegarder localement
                        localStorage.setItem('currentRestaurant', JSON.stringify(currentRestaurant));
                        
                        const currentAccessCodeInput = document.getElementById('currentAccessCode');
                        if (currentAccessCodeInput) {
                            currentAccessCodeInput.value = newCode;
                        }
                        newCodeInput.value = '';
                        
                        showMessage('Code changé avec succès!', 'success');
                    } catch (error) {
                        showMessage('Erreur lors du changement de code', 'danger');
                    }
                });
            }
            
            // Effacer toutes les données
            const clearDataBtn = document.getElementById('clearData');
            if (clearDataBtn) {
                clearDataBtn.addEventListener('click', async function() {
                    if (confirm('⚠️ ATTENTION ! Cette action supprimera TOUTES les données de votre restaurant. Cette action est irréversible. Continuer ?')) {
                        try {
                            // Réinitialiser les données
                            stockData = {
                                products: [],
                                movements: [],
                                settings: {
                                    restaurantName: currentRestaurant.name,
                                    accessCode: currentRestaurant.accessCode,
                                    lastSync: new Date().toISOString()
                                }
                            };
                            
                            // Sauvegarder dans Firebase
                            await saveDataToFirebase();
                            
                            // Mettre à jour l'interface
                            loadProducts();
                            updateDashboard();
                            loadRecentMovements();
                            
                            showMessage('Toutes les données ont été effacées', 'success');
                        } catch (error) {
                            showMessage('Erreur lors de la suppression', 'danger');
                        }
                    }
                });
            }
        }

        // Démarrer l'application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>